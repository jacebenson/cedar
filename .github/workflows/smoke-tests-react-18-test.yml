name: üîÑ Smoke Tests React 18 Test

on:
  workflow_call:
    inputs:
      os:
        required: true
        type: string

jobs:
  smoke-tests-react-18:
    runs-on: ${{ inputs.os }}

    env:
      REDWOOD_CI: 1
      REDWOOD_VERBOSE_TELEMETRY: 1

    steps:
      - name: Checkout the framework code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Set up job
        uses: ./.github/actions/set-up-job
        with:
          build: false

      - name: Downgrade to React 18
        run: |
          yarn tsx ./tasks/downgradeToReact18.mts

      # One of our dependencies is on GitHub instead of NPM and without authentication
      # we'll get rate limited and this step becomes flaky.
      - name: üêà Yarn install
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
          YARN_ENABLE_IMMUTABLE_INSTALLS: false
        run: yarn install --inline-builds

      - name: üèóÔ∏è Build
        shell: bash
        run: yarn build

      - name: üå≤ Set up test project for React 18
        id: set-up-test-project-react-18
        uses: ./.github/actions/set-up-test-project
        env:
          REDWOOD_DISABLE_TELEMETRY: 1
          YARN_ENABLE_IMMUTABLE_INSTALLS: false

      - name: üé≠ Install playwright dependencies
        run: npx playwright install --with-deps chromium

      - name: üßë‚Äçüíª Run dev smoke tests
        working-directory: ./tasks/smoke-tests/dev
        run: npx playwright test
        env:
          REDWOOD_TEST_PROJECT_PATH: '${{ steps.set-up-test-project-react-18.outputs.test-project-path }}'
          REDWOOD_DISABLE_TELEMETRY: 1

      - name: üîê Run auth smoke tests
        working-directory: ./tasks/smoke-tests/auth
        run: npx playwright test
        env:
          REDWOOD_TEST_PROJECT_PATH: ${{ steps.set-up-test-project-react-18.outputs.test-project-path }}
          REDWOOD_DISABLE_TELEMETRY: 1

      - name: Run `cedar build --no-prerender`
        run: |
          yarn cedar build --no-prerender
        working-directory: ${{ steps.set-up-test-project-react-18.outputs.test-project-path }}

      - name: Run `cedar prerender`
        run: |
          yarn cedar prerender --verbose
        working-directory: ${{ steps.set-up-test-project-react-18.outputs.test-project-path }}

      - name: üñ•Ô∏è Run serve smoke tests
        working-directory: tasks/smoke-tests/serve
        run: npx playwright test
        env:
          REDWOOD_TEST_PROJECT_PATH: ${{ steps.set-up-test-project-react-18.outputs.test-project-path }}
          REDWOOD_DISABLE_TELEMETRY: 1

      - name: üìÑ Run prerender smoke tests
        working-directory: tasks/smoke-tests/prerender
        run: npx playwright test
        env:
          REDWOOD_TEST_PROJECT_PATH: ${{ steps.set-up-test-project-react-18.outputs.test-project-path }}
          REDWOOD_DISABLE_TELEMETRY: 1

      - name: üìï Run Storybook smoke tests
        working-directory: tasks/smoke-tests/storybook
        run: npx playwright test
        env:
          REDWOOD_TEST_PROJECT_PATH: ${{ steps.set-up-test-project-react-18.outputs.test-project-path }}
          REDWOOD_DISABLE_TELEMETRY: 1
